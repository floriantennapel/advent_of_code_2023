part2 is a complete rewrite and is not really related to part1 at all. part1 is really messy and I might change it later.
